<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Arqueo de Caja (Con Datos Externos) (CLP)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <style>
        /* ---------------------------------------------------- */
        /* CSS: Estilos principales y Modal (CON SCROLL EN DETALLE) */
        /* ---------------------------------------------------- */
        body {
            font-family: sans-serif;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            max-width: 1000px; 
            width: 100%;
        }

        h1, h2 {
            color: #007bff;
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .main-layout {
            display: flex;
            gap: 20px; 
            margin-top: 20px;
        }
        
        .left-column {
            flex-basis: 40%; 
            min-width: 350px;
            flex-grow: 1;
        }
        
        .right-column {
            flex-basis: 60%; 
            flex-grow: 1;
        }

        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
        }

        .main-actions {
            display: grid; 
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .main-actions button, .main-actions a {
            flex-grow: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em; 
            cursor: pointer;
            font-weight: bold;
            text-decoration: none; 
            text-align: center;
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        
        .input-group {
            margin: 15px 0;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        #esperadoDisplay {
            display: block;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            font-size: 1.1em;
            text-align: right;
            box-sizing: border-box;
            background-color: #f8f8f8; 
            color: #007bff; 
        }

        #divisor-info {
            margin-top: 10px; 
            padding: 10px; 
            border: 1px solid #007bff; 
            border-radius: 5px; 
            background-color: #e6f0ff;
            margin-bottom: 15px;
        }
        
        .update-info-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
        }
        
        button.compare-button {
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 20px;
            margin-bottom: 20px; 
        }
        
        #desglose-esperado table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        #desglose-esperado th, #desglose-esperado td {
            border: 1px solid #eee;
            padding: 6px;
        }
        #desglose-esperado th {
            background-color: #f2f2f2;
            color: #007bff;
            text-align: left;
        }
        #desglose-esperado td:last-child {
            text-align: right;
            font-weight: bold;
        }
        
        #desglose-contado table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border: 1px solid #ddd; 
        }

        #desglose-contado th, #desglose-contado td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        
        #desglose-contado th {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
            text-align: center;
        }
        
        #desglose-contado td:first-child {
            text-align: left; 
        }
        
        .total-summary {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 2px solid #007bff;
        }
        
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        .denominacion-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #ccc;
            width: 100%; 
            gap: 5px; 
        }
        
        .denominacion-row label {
            font-weight: bold;
            flex-basis: 35%; 
            flex-shrink: 0;
            font-size: 0.9em; 
        }
        
        #arqueo-form input[type="number"]:not(.cantidad-input) {
            width: 40px; 
            padding: 5px 3px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
            flex-shrink: 0;
        }

        .button-group {
            display: flex;
            gap: 3px; 
            flex-shrink: 0;
        }

        .denominacion-row button {
            width: 30px; 
            padding: 5px 0;
            font-size: 0.8em; 
            margin-top: 0;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-add { background-color: #28a745; }
        .btn-retire { background-color: #d9534f; }
        .btn-edit-detalle { 
            background-color: #007bff; 
            width: 25px; 
            margin-left: 5px;
        }

        .total-display {
            flex-grow: 1; 
            max-width: 140px; 
            text-align: right;
            font-weight: bold;
            color: #28a745;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-left: auto; 
        }

        .total-display input.cantidad-input {
            width: 55px; 
            padding: 3px;
            border: 1px solid #007bff; 
            border-radius: 4px;
            text-align: right;
            font-size: 0.8em; 
            color: #007bff;
            font-weight: bold;
            box-sizing: border-box;
            margin-bottom: 2px;
        }
        
        .cantidad-controls-wrapper {
            display: flex; 
            align-items: center; 
            justify-content: flex-end;
            width: 100%;
            gap: 3px; 
        }

        .total-display .cantidad-total-moneda {
            font-size: 0.8em; 
            color: #333;
            margin-top: 3px;
        }
        
        .total-display .detalle-movimiento {
            overflow-x: auto; 
            white-space: nowrap; 
            max-width: 100%; 
            padding-right: 3px; 
            font-size: 0.7em; 
            font-weight: normal;
            color: #666;
            margin-top: 2px;
            text-align: right; 
        }
        
        #movimientos-edicion {
            list-style: none;
            padding: 0;
        }
        #movimientos-edicion li {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #eee;
            border-radius: 4px;
            gap: 10px; 
        }
        
        .sign-control {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
            width: 70px; 
        }

        .sign-control button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            flex-grow: 1;
        }
        
        .sign-control button.active-sign {
            background-color: #007bff;
            color: white;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        .sign-control button:not(.active-sign) {
            background-color: #f0f0f0;
            color: #6c757d;
            border: 1px solid #ccc;
        }

        #movimientos-edicion li input {
            width: 100%; 
            padding: 5px;
            font-size: 1.1em;
            border: 1px solid #ccc;
            text-align: right;
            flex-grow: 1;
        }

        #history-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 15px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
        }
        
        #history-controls button:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
        }

        .mensaje.cuadrado { background-color: #d4edda; color: #155724; padding: 10px; border-radius: 5px;}
        .mensaje.sobrante { background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px;}
        .mensaje.faltante { background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;}
        .error-fetch { background-color: #d9534f; color: white; padding: 10px; border-radius: 5px; text-align: center; }
        
        .backup-controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .backup-controls button, .backup-controls label {
            flex-grow: 1;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            border: none;
        }
        
        #import-file-label {
            background-color: #f0ad4e;
            color: white;
            font-weight: bold;
        }
        #import-file {
            display: none; 
        }
        
        #historyModal .modal-content {
             max-width: 900px; 
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .history-table th, .history-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            vertical-align: top; 
        }
        .history-table th {
            background-color: #e9e9e9;
            color: #333;
            font-weight: bold;
        }
        
        /* Ajuste para las nuevas columnas */
        .history-table th:nth-child(2), .history-table td:nth-child(2) { 
            text-align: center; 
        }
        /* PUNTO DIARIO */
        .history-table th:nth-child(3), .history-table td:nth-child(3) { 
            text-align: right; 
            font-weight: bold;
            color: #28a745;
        }
        /* TOTAL RECAUDADO */
        .history-table th:nth-child(4), .history-table td:nth-child(4) { 
            text-align: right; 
            font-weight: bold;
            color: #007bff;
        }
        
        .history-table .date-group-odd {
            background-color: #f0f0f0; 
        }
        .history-table .date-group-even {
            background-color: #ffffff; 
        }

        #filter-controls {
            display: flex; 
            gap: 10px;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        #filter-controls label {
            font-weight: bold;
            flex-shrink: 0;
        }
        #divisorFilter {
            padding: 8px;
            border: 1px solid #007bff;
            border-radius: 4px;
            flex-grow: 1;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üí∞ Arqueo de Caja (CLP)</h1>
        
        <div class="main-actions">
            <button onclick="abrirModalConteo()" style="background-color: #007bff; color: white;">
                üí∏ Ingresar/Retirar Efectivo
            </button>
            <button onclick="abrirModalDetalle()" style="background-color: #6c757d; color: white;">
                üìú Ver Detalle de Movimientos
            </button>
            <button onclick="openHistoryModal()" style="background-color: #17a2b8; color: white;">
                üìã Ver Historial Apps Script
            </button>
            </div>
        
        <div class="main-layout">
            
            <div class="left-column">
                
                <div class="input-group">
                    <label for="esperadoDisplay">Total Recaudado **Esperado** (CLP):</label>
                    <strong id="esperadoDisplay">Cargando...</strong>
                    
                    <div id="divisor-info">
                        <p style="margin: 0;">
                            <strong>Total D√≠a (√öltimo Reg.):</strong> 
                            <span class="day-total-display" id="divisor-day-total" style="color:#007bff; font-weight: bold;">$0</span>
                            <small id="divisor-date" style="display: block; margin-top: 3px; font-size: 0.8em;">Fecha: N/A</small>
                        </p>
                        <p style="margin: 5px 0 0 0; border-bottom: 1px dotted #ccc; padding-bottom: 5px;">
                            <strong>√öltimo Divisor:</strong> 
                            <span class="divisor-value-display" id="divisor-value" style="color:#007bff; font-weight: bold;">1</span>
                        </p>
                        <p style="margin: 5px 0 0 0; border-bottom: 1px dotted #007bff; padding-bottom: 5px;">
                            <strong>üí∞ Punto del D√≠a (C√°lculo Inverso):</strong> 
                            <span id="punto-del-dia" style="color:#28a745; font-weight: bold;">N/A</span>
                        </p>
                        <p style="margin: 5px 0 0 0; background-color: #ccffcc; padding: 5px; border-radius: 4px;">
                            <strong>üìä TOTAL Puntos (Historial):</strong> 
                            <span id="suma-total-puntos-historial" style="color:#28a745; font-weight: bold;">N/A</span>
                        </p>
                        <div style="margin-top: 15px; border-top: 1px dashed #007bff; padding-top: 10px;">
                            <label for="divisor-planta" style="font-weight: bold; display: block; margin-bottom: 5px;">Divisor Planta (S√≥lo Dato):</label>
                            <input type="number" id="divisor-planta" value="1.0" step="0.01" style="width: 100%; padding: 5px; border: 1px solid #007bff; border-radius: 4px; text-align: right;">
                        </div>
                        <div style="margin-top: 10px;">
                            <label for="divisor-part-time" style="font-weight: bold; display: block; margin-bottom: 5px;">Divisor Part-Time (Para Filtro):</label>
                            <input type="number" id="divisor-part-time" value="1.0" step="0.01" style="width: 100%; padding: 5px; border: 1px solid #007bff; border-radius: 4px; text-align: right;">
                        </div>
                    </div>
                    <div id="desglose-esperado-container">
                        <h3 style="margin: 10px 0 5px 0; color: #333; font-size: 1.1em; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                            Detalle de Recaudaciones Esperadas
                        </h3>
                        <div id="desglose-esperado">
                            <p style="text-align: center; color: #666;">Esperando datos del servidor...</p>
                        </div>
                    </div>
                    <div class="update-info-container">
                        <small id="update-status" style="display: block; color: #007bff;">Valor cargado autom√°ticamente desde el Apps Script.</small>
                        <button onclick="fetchEsperadoData()" style="padding: 5px 10px; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>

                <button class="compare-button" onclick="realizarArqueo()">Realizar Arqueo y Comparar</button>

                <div class="backup-controls">
                    <button onclick="exportarDataToJson()" style="background-color: #5cb85c; color: white;">
                        üì• Exportar Datos (JSON)
                    </button>
                    <input type="file" id="import-file" accept=".json" onchange="importarDataFromJson(event)">
                    <label for="import-file" id="import-file-label">
                        ‚¨ÜÔ∏è Importar Datos (JSON)
                    </label>
                </div>
                </div>
            
            <div class="right-column">
                
                <div id="resultados">
                    <h2>Resultados del Conteo Total:</h2>
                    <div id="desglose-contado"></div>
                    
                    <div class="total-summary">
                        <p>
                            <strong>TOTAL en CAJA:</strong> 
                            <span id="total-contado-final" style="color:#28a745;">$0</span>
                        </p>
                        <p>
                            <strong>TOTAL RETIRADO (Efectivo):</strong> 
                            <span id="total-retiros-final">$0</span>
                        </p>
                    </div>
                </div>

                <div id="comparacion">
                    <h2>An√°lisis del Arqueo:</h2>
                    <p><strong>Total EGRESO (Contado - Esperado):</strong> <span id="diferencia">$0</span></p>
                    <p><strong>üìä TOTAL Puntos (Historial):</strong> <span id="division-result">N/A</span></p>
                    <p id="mensaje-arqueo" class="mensaje"></p>
                </div>

            </div>
        
        </div>
        </div>
    
    <div id="modalConteo" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalConteo()">&times;</span>
            <h2>üí∏ Gesti√≥n de Efectivo</h2>
            <p>
                Puedes usar **+** o **-** para movimientos incrementales, **escribir directamente la cantidad total**, o usar **...** para editar el historial de movimientos.
            </p>
            
            <div id="history-controls">
                <button id="undo-btn" onclick="undoAction()" style="background-color: #ffc107; color: #333;" disabled>
                    ‚Ü©Ô∏è Deshacer √öltima Acci√≥n
                </button>
                <button id="redo-btn" onclick="redoAction()" style="background-color: #17a2b8; color: white;" disabled>
                    ‚Ü™Ô∏è Rehacer
                </button>
            </div>
            
            <div id="arqueo-form">
                </div>
            
            <button onclick="cerrarModalConteo(true)" style="background-color: #007bff; color: white; width: 100%; margin-top: 20px;">
                Guardar Cambios y Cerrar Gesti√≥n
            </button>
        </div>
    </div>

    <div id="modalEdicionDetalle" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalEdicionDetalle()">&times;</span>
            <h2 id="edicion-detalle-titulo">‚úèÔ∏è Editar Movimientos de [Denominaci√≥n]</h2>
            <p>Edita la **cantidad** y el **signo (+/-)** de cada movimiento.</p>
            
            <ul id="movimientos-edicion">
                </ul>

            <button onclick="guardarEdicionDetalle()" style="background-color: #28a745; color: white; width: 100%; margin-top: 20px;">
                Guardar Correcciones
            </button>
        </div>
    </div>
    
    <div id="modalDetalle" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalDetalle()">&times;</span>
            <h2>üìú Detalle de Ingresos y Retiros</h2>
            <ul id="lista-movimientos"></ul>
            
            <button onclick="limpiarRegistros()" style="background-color: #d9534f; color: white; width: 100%; margin-top: 20px;">
                üóëÔ∏è Reiniciar Conteo y Detalle
            </button>
        </div>
    </div>
    
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHistoryModal()">&times;</span>
            <h2>üìã Historial Detallado (Apps Script)</h2>
            
            <div id="filter-controls">
                <label for="divisorFilter">Filtrar por Divisor:</label>
                <select id="divisorFilter" onchange="fetchHistorialDetallado(true)">
                    <option value="">-- Ver Todo (Total General) --</option>
                    </select>
            </div>
            <div id="history-summary" style="margin-top: 15px; margin-bottom: 15px; padding: 10px; border: 2px solid #28a745; border-radius: 5px;">
                <p style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Solicitando resumen...</p>
            </div>
            <div id="historyContainer">
                <p style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Solicitando tabla...</p>
            </div>
        </div>
    </div>
    <script>
        
        // ** REEMPLAZA ESTA URL CON TU URL DE IMPLEMENTACI√ìN DEL APPS SCRIPT **
        const ESPERADO_URL = 'https://script.google.com/macros/s/AKfycbz_kCb4aEe437zHGbRqnjCibw1NtAqfCbTNmsVPn9jaZOPBFaZ6-FwmiTLqVxq39X1P/exec'; // <--- ¬°ACTUALIZA ESTO!
        
        const FETCH_TIMEOUT_MS = 10000; 

        const DENOMINACIONES = [
            20000, 10000, 5000, 2000, 1000, 
            500, 100, 50, 10 
        ];

        const STORAGE_KEY_CONTEO = 'arqueoConteoCLP';
        const STORAGE_KEY_DETALLE = 'arqueoDetalleCLP';
        const STORAGE_KEY_RETIROS = 'arqueoRetirosCLP'; 
        const STORAGE_KEY_HISTORY = 'arqueoHistoryCLP';
        const STORAGE_KEY_PUNTO_DIA_VALOR = 'arqueoPuntoDiaValorCLP';
        const STORAGE_KEY_DIVISOR_VALOR = 'arqueoDivisorValorCLP'; 
        const STORAGE_KEY_SUMA_PUNTOS = 'arqueoSumaPuntosCLP'; 
        const STORAGE_KEY_DIVISOR_PLANTA = 'arqueoDivisorPlantaCLP'; 
        const STORAGE_KEY_DIVISOR_PARTTIME = 'arqueoDivisorPartTimeCLP'; 

        const contenedorForm = document.getElementById('arqueo-form');
        const totalContadoFinalSpan = document.getElementById('total-contado-final');
        const totalRetirosFinalSpan = document.getElementById('total-retiros-final');
        const desgloseContadoDiv = document.getElementById('desglose-contado');
        const diferenciaSpan = document.getElementById('diferencia');
        const mensajeArqueoP = document.getElementById('mensaje-arqueo');
        const listaMovimientosUl = document.getElementById('lista-movimientos');
        const esperadoDisplay = document.getElementById('esperadoDisplay'); 
        const updateStatusSpan = document.getElementById('update-status'); 
        const desgloseEsperadoDiv = document.getElementById('desglose-esperado'); 
        
        const divisorDayTotalSpan = document.getElementById('divisor-day-total');
        const divisorValueSpan = document.getElementById('divisor-value');
        const divisorDateSpan = document.getElementById('divisor-date');
        const puntoDelDiaSpan = document.getElementById('punto-del-dia'); 
        const divisionResultSpan = document.getElementById('division-result');
        const sumaTotalPuntosHistorialSpan = document.getElementById('suma-total-puntos-historial');

        const modalConteo = document.getElementById('modalConteo'); 
        const modalDetalle = document.getElementById('modalDetalle'); 
        const modalEdicionDetalle = document.getElementById('modalEdicionDetalle'); 
        const historyModal = document.getElementById('historyModal'); 
        const historyContainer = document.getElementById('historyContainer'); 
        const historySummaryDiv = document.getElementById('history-summary');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        
        const divisorPlantaInput = document.getElementById('divisor-planta');
        const divisorPartTimeInput = document.getElementById('divisor-part-time');
        const divisorFilterSelect = document.getElementById('divisorFilter');

        let conteoActual = {}; 
        let detalleMovimientos = []; 
        let totalRetirado = 0; 
        let movimientoDisplay = {}; 
        let puntoDelDiaValor = 0; 
        let ultimoDivisor = 1.0; 
        let sumaTotalPuntos = 0; 

        let history = [];
        let historyIndex = -1;
        
        let denominacionEnEdicion = null; 

        function formatoMoneda(numero) {
            // Asegura que el n√∫mero pasado al formateador es un entero.
            return new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                maximumFractionDigits: 0 
            }).format(Math.round(numero)); 
        }
        
        function formatoFactor(numero) {
            // Mostrar el divisor con dos decimales para precisi√≥n en el filtro
            if (isNaN(numero) || !isFinite(numero)) return "N/A";
            // Usamos toLocaleString para manejar el separador decimal correcto (coma en Chile)
            return parseFloat(numero).toLocaleString('es-CL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); 
        }
        
        function formatoPunto(numero) {
             return formatoMoneda(numero);
        }

        async function fetchEsperadoData() {
            // 1. Resetear interfaz y mostrar estado de carga
            mensajeArqueoP.classList.remove('error-fetch');
            mensajeArqueoP.textContent = '';
            
            esperadoDisplay.textContent = 'Actualizando...';
            divisorDayTotalSpan.textContent = '...';
            divisorValueSpan.textContent = '...';
            divisorDateSpan.textContent = 'Fecha: ...';
            puntoDelDiaSpan.textContent = 'Calculando...';
            desgloseEsperadoDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando datos desde el servidor...'; 
            updateStatusSpan.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conectando con Google Sheets...';
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);

            try {
                // 2. Intentar el Fetch
                const response = await fetch(ESPERADO_URL, { signal: controller.signal });
                clearTimeout(timeoutId); 
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} (${response.statusText})`);
                }
                
                const data = await response.json(); 
                
                // 3. Validaci√≥n M√≠nima y Asignaci√≥n
                if (data.totalAcumulado === undefined || data.lastDivisor === undefined || data.totalLastDivisorDay === undefined) {
                     throw new Error(`Datos faltantes en la respuesta JSON (totalAcumulado, lastDivisor o totalLastDivisorDay).`);
                }
                
                const totalAcumuladoInflado = data.totalAcumulado;
                const lastDivisorValue = parseFloat(data.lastDivisor); 
                const totalLastDivisorDayInflado = data.totalLastDivisorDay; 

                // Montos monetarios: Dividir por 100 y REDONDEAR a entero.
                const expectedValue = Math.round(totalAcumuladoInflado / 100); 
                const totalLastDivisorDay = Math.round(totalLastDivisorDayInflado / 100); 
                const lastDivisorDateString = data.lastDivisorDate || 'N/A'; 
                
                ultimoDivisor = lastDivisorValue || 1.0;

                // 4. C√ÅLCULO DEL PUNTO DEL D√çA (Monto Monetario)
                if (ultimoDivisor && totalLastDivisorDay && ultimoDivisor !== 0) {
                    puntoDelDiaValor = Math.round(totalLastDivisorDay / ultimoDivisor); 
                } else {
                    puntoDelDiaValor = 0; 
                }

                // 5. Manejo del Desglose (AHORA ES OPCIONAL)
                let desgloseEsperado = [];
                if (data.desgloseEsperado && Array.isArray(data.desgloseEsperado)) {
                    desgloseEsperado = data.desgloseEsperado.map(item => ({
                        tipo: item.tipo,
                        monto: Math.round((item.monto || 0) / 100) 
                    }));
                } 

                // 6. L√≥gica de Fecha
                let formattedDateWithDay = 'Fecha: N/A';
                if (lastDivisorDateString && lastDivisorDateString !== 'N/A') {
                    const dateParts = lastDivisorDateString.split('-'); 
                    if (dateParts.length === 3) {
                         const compatibleDateString = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`; 
                         const dateObj = new Date(compatibleDateString); 
                         if (!isNaN(dateObj)) {
                            const formattedDateOnly = `${dateParts[0]}-${dateParts[1]}-${dateParts[2]}`; 
                            const dayName = dateObj.toLocaleDateString('es-CL', { weekday: 'long' });
                            const capitalizedDayName = dayName.charAt(0).toUpperCase() + dayName.slice(1);
                            formattedDateWithDay = `Fecha: ${formattedDateOnly} **${capitalizedDayName}**`;
                         } else {
                            formattedDateWithDay = `Fecha: ${lastDivisorDateString} (Formato Inv√°lido)`;
                         }
                    } else {
                        formattedDateWithDay = `Fecha: ${lastDivisorDateString}`;
                    }
                }

                // 7. ACTUALIZAR PANTALLA Y ESTADO LOCAL
                esperadoDisplay.textContent = formatoMoneda(expectedValue); 
                divisorDayTotalSpan.textContent = formatoMoneda(totalLastDivisorDay); 
                // Usar el valor exacto del divisor para guardarlo y mostrarlo en formato factor
                divisorValueSpan.textContent = formatoFactor(ultimoDivisor); 
                divisorDateSpan.textContent = formattedDateWithDay; 
                
                puntoDelDiaSpan.textContent = formatoPunto(puntoDelDiaValor);
                localStorage.setItem(STORAGE_KEY_PUNTO_DIA_VALOR, puntoDelDiaValor.toString());
                localStorage.setItem(STORAGE_KEY_DIVISOR_VALOR, ultimoDivisor.toString()); 
                
                // 8. POBAR EL FILTRO DEL MODAL
                populateDivisorFilter(); 

                if (desgloseEsperado.length > 0) {
                    mostrarDesgloseEsperado(desgloseEsperado);
                } else {
                    desgloseEsperadoDiv.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No se recibi√≥ desglose detallado del servidor.</p>';
                }

                const now = new Date().toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                updateStatusSpan.innerHTML = `√öltima actualizaci√≥n: <strong>${now}</strong> (Manual)`;

                realizarArqueo();

            } catch (error) {
                clearTimeout(timeoutId); 

                let errorMessage;
                if (error.name === 'AbortError') {
                    errorMessage = "Tiempo de espera agotado (Timeout).";
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = "Error de red/CORS. Aseg√∫rate que la URL es correcta y el Apps Script permite acceso a 'Cualquier persona'.";
                } else {
                    errorMessage = `Fallo al procesar datos: ${error.message}`;
                }

                console.error("Error al obtener el Efectivo Esperado desde el Apps Script:", error);
                
                esperadoDisplay.textContent = formatoMoneda(0); 
                divisorDayTotalSpan.textContent = formatoMoneda(0);
                divisorValueSpan.textContent = '1'; 
                divisorDateSpan.textContent = 'Fecha: N/A';
                puntoDelDiaValor = 0; 
                ultimoDivisor = 1.0;
                puntoDelDiaSpan.textContent = formatoMoneda(0);
                desgloseEsperadoDiv.innerHTML = '<p style="text-align: center; color: #d9534f; font-weight: bold;">üö® Error al cargar datos.</p>';
                updateStatusSpan.innerHTML = `<span style="color:#d9534f;">Error de conexi√≥n: ${errorMessage}</span>`;
                mensajeArqueoP.textContent = "üö® ERROR AL CARGAR DATOS ESPERADOS.";
                mensajeArqueoP.classList.add('error-fetch');
                
                realizarArqueo(); 
            }
        }
        
        function populateDivisorFilter() {
            // Limpiar opciones anteriores
            divisorFilterSelect.innerHTML = '<option value="">-- Ver Todo (Total General) --</option>';
            
            // Recoger los divisores relevantes para el FILTRO
            const divisores = new Set();
            
            // 1. Ultimo Divisor de Apps Script
            const ultimoDivisorValue = parseFloat(localStorage.getItem(STORAGE_KEY_DIVISOR_VALOR)) || 1.0;
            if (ultimoDivisorValue !== 1.0) divisores.add(ultimoDivisorValue);
            
            // 2. Divisor Part-Time (del input local) - ESTE ES EL DIVISOR CLAVE PARA FILTRAR
            const divisorPartTimeValue = parseFloat(divisorPartTimeInput.value) || 1.0;
            if (divisorPartTimeValue !== 1.0) divisores.add(divisorPartTimeValue);
            
            // El Divisor Planta (divisorPlantaInput.value) NO se a√±ade aqu√≠, 
            // ya que solo es un dato de referencia en la interfaz principal.

            // 3. A√±adir el divisor '1.0' si no est√° (para ver el divisor por defecto)
            divisores.add(1.0); 

            // Ordenar y crear opciones
            const sortedDivisores = Array.from(divisores).sort((a, b) => b - a);
            
            sortedDivisores.forEach(divisor => {
                const formattedDivisor = formatoFactor(divisor); // Ej. 1,00
                const value = divisor.toFixed(2); // Usar el valor fijo de 2 decimales para la coincidencia de 'value'
                
                let label = `Divisor ${formattedDivisor}`;
                // Etiquetar claramente los divisores que se usan
                if (divisor === divisorPartTimeValue) label = `Divisor ${formattedDivisor} (Part-Time)`;
                if (divisor === ultimoDivisorValue && divisor !== divisorPartTimeValue) label = `Divisor ${formattedDivisor} (√öltimo Reg)`;

                const option = document.createElement('option');
                option.value = value;
                option.textContent = label;
                divisorFilterSelect.appendChild(option);
            });
        }
        
        function mostrarDesgloseEsperado(data) {
            if (!data || data.length === 0) {
                desgloseEsperadoDiv.innerHTML = '<p style="text-align: center; color: #666;">No hay desglose disponible.</p>';
                return;
            }
            
            let totalDesglose = 0;
            let totalMaquinasMesas = 0; 
            
            let html = '<table>';
            html += '<thead><tr><th>Tipo Recaudaci√≥n</th><th>Monto Esperado</th></tr></thead>';
            html += '<tbody>';
            
            data.forEach(item => {
                const monto = item.monto || 0;
                html += `
                    <tr>
                        <td>${item.tipo}</td>
                        <td>${formatoMoneda(monto)}</td>
                    </tr>
                `;
                totalDesglose += monto;
                
                const tipoLower = item.tipo.toLowerCase();
                if (tipoLower.includes('m√°quina') || tipoLower.includes('maquina') || tipoLower.includes('mesa')) {
                    totalMaquinasMesas += monto;
                }
            });
            
            html += '</tbody>';
            html += '<tfoot>';
            
            html += `
                <tr style="border-top: 1px dashed #007bff;">
                    <td style="font-weight: bold; color: #6c757d;">TOTAL M√ÅQUINAS Y MESAS</td>
                    <td style="font-weight: bold; color: #6c757d;">${formatoMoneda(totalMaquinasMesas)}</td>
                </tr>
            `;
            
            html += `
                <tr style="border-top: 2px solid #007bff;">
                    <td style="font-weight: bold;">TOTAL ESPERADO (Suma General)</td>
                    <td style="font-weight: bold; color: #007bff;">${formatoMoneda(totalDesglose)}</td>
                </tr>
            `;
            html += '</tfoot></table>';
            
            desgloseEsperadoDiv.innerHTML = html;
        }

        async function openHistoryModal() {
            historyModal.style.display = 'block';
            populateDivisorFilter(); 
            // Cargar con el valor de filtro actual (que puede ser vac√≠o al abrir)
            await fetchHistorialDetallado(true); 
        }

        function closeHistoryModal() {
            historyModal.style.display = 'none';
        }

        async function fetchHistorialDetallado(isModal = false) {
            const HISTORIAL_URL = `${ESPERADO_URL}?action=get`;
            
            const selectedDivisor = isModal ? divisorFilterSelect.value : null; 
            
            if (isModal) {
                historyContainer.innerHTML = '<p style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Solicitando tabla...</p>';
                historySummaryDiv.innerHTML = '<p style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Solicitando resumen...</p>';
            }
            // Si no estamos en el modal, actualizamos el resumen en el panel principal
            if (!isModal) {
                 sumaTotalPuntosHistorialSpan.textContent = 'Calculando...';
            }
            
            try {
                const response = await fetch(HISTORIAL_URL);
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                
                const result = await response.json();
                
                if (result.status === 'success' && Array.isArray(result.data)) {
                    // Pasamos el historial, el contenedor, si es un modal, y el valor del filtro
                    renderHistoryTable(result.data, historyContainer, isModal, selectedDivisor); 
                } else {
                    const message = `Error: ${result.message || 'Respuesta no exitosa o formato incorrecto.'}`;
                    if (isModal) {
                       historyContainer.innerHTML = `<p class="error-fetch">${message}</p>`;
                       historySummaryDiv.innerHTML = '';
                    } else {
                        console.error(message);
                    }
                    sumaTotalPuntosHistorialSpan.textContent = formatoMoneda(0);
                    divisionResultSpan.textContent = formatoMoneda(0);
                    localStorage.setItem(STORAGE_KEY_SUMA_PUNTOS, '0');
                }
            } catch (error) {
                const message = `Error al obtener el historial detallado: ${error.message}`;
                if (isModal) {
                    historyContainer.innerHTML = `<p class="error-fetch">${message}</p>`;
                    historySummaryDiv.innerHTML = '';
                } else {
                    console.error(message);
                }
                sumaTotalPuntosHistorialSpan.textContent = formatoMoneda(0);
                divisionResultSpan.textContent = formatoMoneda(0);
                localStorage.setItem(STORAGE_KEY_SUMA_PUNTOS, '0');
                console.error("Error al obtener el historial detallado:", error);
            }
        }

        function renderHistoryTable(historial, container, isModal, divisorFilterValue = null) {
            
            if (historial.length === 0) {
                if (isModal) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No hay registros de recaudaciones detallados en la hoja "Datos".</p>';
                    historySummaryDiv.innerHTML = '';
                }
                sumaTotalPuntos = 0;
                sumaTotalPuntosHistorialSpan.textContent = formatoMoneda(0);
                divisionResultSpan.textContent = formatoMoneda(0);
                localStorage.setItem(STORAGE_KEY_SUMA_PUNTOS, '0');
                return;
            }

            const dailySummary = {};
            
            // 1. Agrupar por fecha y calcular el total de recaudaci√≥n diario, y guardar el divisor
            historial.forEach(registro => {
                const dateKey = registro.fecha.split(' ')[0];
                const monto = Math.round(parseFloat(registro.monto || 0)); 
                const tipo = registro.tipo || 'Sin Tipo';
                const divisor = parseFloat(registro.divisor) || 1.0; 

                if (!dailySummary[dateKey]) {
                    dailySummary[dateKey] = {
                        date: dateKey,
                        total: 0,
                        types: {},
                        divisor: divisor 
                    };
                }

                dailySummary[dateKey].total += monto;
                if (!dailySummary[dateKey].types[tipo]) {
                    dailySummary[dateKey].types[tipo] = 0;
                }
                dailySummary[dateKey].types[tipo] += monto;
            });

            const summaryArray = Object.values(dailySummary).sort((a, b) => {
                return b.date.localeCompare(a.date);
            });
            
            let sumaTotalPuntosAcumulada = 0; 
            let totalMontoRecaudado = 0; 
            let filteredDaysCount = 0; 
            
            // 2. Filtrar y generar HTML/calcular totales
            
            const filteredSummaryArray = summaryArray.filter(dayData => {
                 // Si no hay filtro o si el divisor del d√≠a coincide con el valor del filtro (comparando con 2 decimales fijos)
                if (!divisorFilterValue || divisorFilterValue === "") {
                    return true;
                }
                // Convertir el divisor del d√≠a a string con 2 decimales fijos para la comparaci√≥n
                const dayDivisorFixed = dayData.divisor.toFixed(2);
                return dayDivisorFixed === divisorFilterValue;
            });
            
            if (filteredSummaryArray.length === 0 && isModal && divisorFilterValue && divisorFilterValue !== "") {
                container.innerHTML = `<p style="text-align: center; color: #d9534f; font-weight: bold;">üö® No se encontraron registros con el Divisor: ${formatoFactor(parseFloat(divisorFilterValue))}.</p>`;
                historySummaryDiv.innerHTML = '';
                sumaTotalPuntos = 0;
                localStorage.setItem(STORAGE_KEY_SUMA_PUNTOS, '0');
                return;
            }


            // Solo renderizar la tabla si estamos en el modal
            if (isModal) {
                let html = '<table class="history-table">';
                html += '<thead><tr><th>Fecha</th><th>Divisor Diario</th><th>PUNTO DIARIO</th><th>TOTAL RECAUDADO DEL D√çA</th><th>Desglose por Tipo de Entrada</th></tr></thead>';
                html += '<tbody>';

                let currentColorClass = 'date-group-odd';

                filteredSummaryArray.forEach((dayData, index) => {
                    currentColorClass = (index % 2 === 0) ? 'date-group-odd' : 'date-group-even';

                    let puntoDiario = 0;
                    let puntoDiarioFormatted = 'N/A';
                    
                    if (dayData.divisor && dayData.divisor !== 0) {
                        puntoDiario = Math.round(dayData.total / dayData.divisor);
                        puntoDiarioFormatted = formatoPunto(puntoDiario);
                    } else {
                         puntoDiarioFormatted = 'Divisor es 0';
                    }
                    
                    // Acumular el punto diario y el monto recaudado para el total general/filtrado
                    sumaTotalPuntosAcumulada += puntoDiario; 
                    totalMontoRecaudado += dayData.total;
                    filteredDaysCount++;
                    
                    const parts = dayData.date.split('-'); 
                    let formattedDate;
                    if (parts.length === 3) {
                        const YYYY = parts[0];
                        const MM = parts[1];
                        const DD = parts[2];
                        
                        const compatibleDateString = `${YYYY}/${MM}/${DD}`; 
                        const dateObj = new Date(compatibleDateString); 
                        const formattedDateOnly = `${DD}-${MM}-${YYYY}`; 

                        if (!isNaN(dateObj)) {
                            const dayName = dateObj.toLocaleDateString('es-CL', { weekday: 'long' });
                            const capitalizedDayName = dayName.charAt(0).toUpperCase() + dayName.slice(1);
                            formattedDate = `${formattedDateOnly} **${capitalizedDayName}**`; 
                        } else {
                             formattedDate = formattedDateOnly; 
                        }
                    } else {
                        formattedDate = dayData.date; 
                    }

                    let typeBreakdown = '';
                    const sortedTypes = Object.entries(dayData.types).sort(([tipoA], [tipoB]) => tipoA.localeCompare(tipoB));
                    
                    sortedTypes.forEach(([tipo, monto]) => {
                        typeBreakdown += `<p style="margin: 0; font-size: 0.9em;"><strong>${tipo}:</strong> ${formatoMoneda(monto)}</p>`;
                    });
                    
                    if (typeBreakdown === '') {
                        typeBreakdown = '<p style="margin: 0; font-style: italic; color: #666;">Sin desglose disponible.</p>';
                    }

                    html += `
                        <tr class="${currentColorClass}">
                            <td style="font-weight: bold; font-size: 1.1em;">${formattedDate}</td>
                            <td style="text-align: center; font-weight: bold; color: #17a2b8; font-size: 1.1em;">
                                ${formatoFactor(dayData.divisor)}
                            </td>
                            <td style="font-weight: bold; color: #28a745; font-size: 1.1em; text-align: right;">
                                ${puntoDiarioFormatted}
                            </td>
                            <td style="font-weight: bold; color: #007bff; font-size: 1.1em; text-align: right;">
                                ${formatoMoneda(dayData.total)}
                            </td>
                            <td style="font-size: 0.9em;">${typeBreakdown}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
                
                // INYECTAR RESUMEN DE TOTALES EN EL MODAL
                const filterTitle = divisorFilterValue && divisorFilterValue !== "" ? 
                    ` (Filtrado por Divisor ${formatoFactor(parseFloat(divisorFilterValue))} - ${filteredDaysCount} d√≠as)` : 
                    " (Total General)";

                historySummaryDiv.innerHTML = `
                    <p style="margin: 0; font-size: 1.2em;">
                        <strong>üìä Total Acumulado de Puntos Diarios ${filterTitle}:</strong> 
                        <span style="color:#28a745; font-weight: bold;">${formatoMoneda(sumaTotalPuntosAcumulada)}</span>
                    </p>
                    <p style="margin: 5px 0 0 0; font-size: 1.2em;">
                        <strong>üí∞ Total Recaudado (Suma Mes/Periodo ${filterTitle}):</strong> 
                        <span style="color:#007bff; font-weight: bold;">${formatoMoneda(totalMontoRecaudado)}</span>
                    </p>
                `;

            } else {
                // Si no es el modal, solo necesitamos el c√°lculo de la suma total de puntos (siempre SIN filtro)
                let tempSuma = 0;
                 summaryArray.forEach((dayData) => {
                    let puntoDiario = 0;
                    if (dayData.divisor && dayData.divisor !== 0) {
                        puntoDiario = Math.round(dayData.total / dayData.divisor);
                    }
                    tempSuma += puntoDiario; 
                });
                sumaTotalPuntosAcumulada = tempSuma;
            }
            
            // 3. Actualizar la variable global, el localStorage y el span en la pantalla principal (SIN FILTRO)
            // Solo actualizamos la suma total en la pantalla principal si NO estamos en el modal.
            if (!isModal || (isModal && !divisorFilterValue)) {
                sumaTotalPuntos = sumaTotalPuntosAcumulada;
                sumaTotalPuntosHistorialSpan.textContent = formatoMoneda(sumaTotalPuntosAcumulada);
                divisionResultSpan.textContent = formatoMoneda(sumaTotalPuntosAcumulada); 
                localStorage.setItem(STORAGE_KEY_SUMA_PUNTOS, sumaTotalPuntosAcumulada.toString());
            }
        }

        // --- M√âTODOS DE ESTADO Y ALMACENAMIENTO (Sin cambios significativos en l√≥gica, solo llamadas) ---
        
        function guardarEstado(nuevoConteo, nuevoDetalle, nuevoTotalRetirado, nuevoMovimientoDisplay) {
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            
            const nuevoEstado = {
                conteo: JSON.parse(JSON.stringify(nuevoConteo)),
                detalle: JSON.parse(JSON.stringify(nuevoDetalle)),
                retiros: nuevoTotalRetirado, 
                movimientoDisplay: JSON.parse(JSON.stringify(nuevoMovimientoDisplay))
            };
            
            history.push(nuevoEstado);
            historyIndex = history.length - 1;
            
            if (history.length > 20) {
                history.shift();
                historyIndex--;
            }
            
            actualizarControlesHistoria();
            guardarEstadoLocal();
        }

        function aplicarEstado(index) {
            if (index >= 0 && index < history.length) {
                const estado = history[index];
                conteoActual = estado.conteo;
                detalleMovimientos = estado.detalle;
                totalRetirado = estado.retiros; 
                movimientoDisplay = estado.movimientoDisplay || {};
                historyIndex = index;
                
                guardarConteo();
                guardarDetalle();
                guardarRetiros();
                generarCampos(); 
                actualizarControlesHistoria();
                realizarArqueo();
            }
        }
        
        function undoAction() {
            if (historyIndex > 0) {
                aplicarEstado(historyIndex - 1);
            }
        }

        function redoAction() {
            if (historyIndex < history.length - 1) {
                aplicarEstado(historyIndex + 1);
            }
        }

        function actualizarControlesHistoria() {
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= history.length - 1;
        }

        function cargarEstado() {
            try {
                const storedConteo = localStorage.getItem(STORAGE_KEY_CONTEO);
                const storedDetalle = localStorage.getItem(STORAGE_KEY_DETALLE);
                const storedRetiros = localStorage.getItem(STORAGE_KEY_RETIROS); 
                const storedHistory = localStorage.getItem(STORAGE_KEY_HISTORY);
                const storedPuntoDiaValor = localStorage.getItem(STORAGE_KEY_PUNTO_DIA_VALOR);
                const storedDivisorValor = localStorage.getItem(STORAGE_KEY_DIVISOR_VALOR);
                const storedSumaPuntos = localStorage.getItem(STORAGE_KEY_SUMA_PUNTOS); 
                const storedDivisorPlanta = localStorage.getItem(STORAGE_KEY_DIVISOR_PLANTA);
                const storedDivisorPartTime = localStorage.getItem(STORAGE_KEY_DIVISOR_PARTTIME);
                
                conteoActual = storedConteo ? JSON.parse(storedConteo) : {};
                detalleMovimientos = storedDetalle ? JSON.parse(storedDetalle) : [];
                totalRetirado = storedRetiros ? parseInt(storedRetiros) : 0; 
                
                puntoDelDiaValor = storedPuntoDiaValor ? parseInt(storedPuntoDiaValor) : 0;
                ultimoDivisor = storedDivisorValor ? parseFloat(storedDivisorValor) : 1.0; 
                sumaTotalPuntos = storedSumaPuntos ? parseInt(storedSumaPuntos) : 0; 
                
                if (storedDivisorPlanta) divisorPlantaInput.value = storedDivisorPlanta;
                if (storedDivisorPartTime) divisorPartTimeInput.value = storedDivisorPartTime;
                
                movimientoDisplay = {}; 

                if (storedHistory) {
                    const h = JSON.parse(storedHistory);
                    history = h.history;
                    historyIndex = h.index;
                    if (history.length > 0) {
                        movimientoDisplay = history[historyIndex].movimientoDisplay || {};
                    }
                } else {
                    guardarEstado(conteoActual, detalleMovimientos, totalRetirado, movimientoDisplay);
                }
                
                puntoDelDiaSpan.textContent = formatoPunto(puntoDelDiaValor);
                divisorValueSpan.textContent = formatoFactor(ultimoDivisor);
                sumaTotalPuntosHistorialSpan.textContent = formatoMoneda(sumaTotalPuntos);
                divisionResultSpan.textContent = formatoMoneda(sumaTotalPuntos);

            } catch (e) {
                console.error("Error cargando localStorage:", e);
                conteoActual = {}; detalleMovimientos = []; totalRetirado = 0; movimientoDisplay = {}; history = []; historyIndex = -1; puntoDelDiaValor = 0; ultimoDivisor = 1.0; sumaTotalPuntos = 0;
                guardarEstado(conteoActual, detalleMovimientos, totalRetirado, movimientoDisplay);
                puntoDelDiaSpan.textContent = formatoMoneda(0);
                divisorValueSpan.textContent = '1';
                sumaTotalPuntosHistorialSpan.textContent = formatoMoneda(0);
                divisionResultSpan.textContent = formatoMoneda(0); 
            }
        }
        
        function guardarEstadoLocal() { localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify({ history: history, index: historyIndex })); }
        function guardarConteo() { localStorage.setItem(STORAGE_KEY_CONTEO, JSON.stringify(conteoActual)); }
        function guardarDetalle() { localStorage.setItem(STORAGE_KEY_DETALLE, JSON.stringify(detalleMovimientos)); }
        function guardarRetiros() { localStorage.setItem(STORAGE_KEY_RETIROS, totalRetirado.toString()); }
        
        // --- M√âTODOS DE INTERFAZ Y ARQUEO (Sin cambios significativos en l√≥gica) ---

        function generarCampos() {
            contenedorForm.innerHTML = '';
            let totalGeneral = calcularTotalGeneral();
            
            DENOMINACIONES.forEach(valor => {
                const esBillete = valor >= 1000;
                const nombreTipo = esBillete ? "Billetes" : "Monedas";
                const valorFormateado = formatoMoneda(valor);
                
                if (conteoActual[valor] === undefined) { conteoActual[valor] = 0; }
                if (movimientoDisplay[valor] === undefined) { movimientoDisplay[valor] = ""; }
                
                const totalPorDenominacion = valor * conteoActual[valor];
                
                const group = document.createElement('div');
                group.className = 'denominacion-row';
                
                let detalleText = movimientoDisplay[valor].length > 0 ? 
                                  `(${movimientoDisplay[valor]})` : 
                                  '(0 movimientos)'; 
                
                group.innerHTML = `
                    <label>${nombreTipo} de ${valorFormateado}:</label>
                    <input type="number" id="input-qty-${valor}" placeholder="Cant." min="0" onfocus="this.value=''">
                    <div class="button-group">
                        <button class="btn-add" onclick="actualizarCantidad(${valor}, 1)">+</button>
                        <button class="btn-retire" onclick="actualizarCantidad(${valor}, -1)">-</button>
                    </div>
                    <div class="total-display" id="total-val-${valor}">
                        <div class="cantidad-controls-wrapper">
                            <input type="number" class="cantidad-input" value="${conteoActual[valor]}" min="0" id="current-qty-${valor}" 
                                    onchange="guardarCambioDirecto(${valor})" onblur="this.value=${conteoActual[valor]}">
                            
                            <button class="btn-edit-detalle" onclick="abrirModalEdicion(${valor})">
                                ...
                            </button>
                        </div>

                        <span class="cantidad-total-moneda">${formatoMoneda(totalPorDenominacion)}</span>
                        
                        <span class="detalle-movimiento">${detalleText}</span>
                    </div>
                `;
                contenedorForm.appendChild(group);
            });
            
            totalContadoFinalSpan.textContent = formatoMoneda(calcularTotalGeneral());
            totalRetirosFinalSpan.textContent = formatoMoneda(totalRetirado); 
        }

        function calcularTotalGeneral() {
            let total = 0;
            DENOMINACIONES.forEach(valor => {
                total += valor * (conteoActual[valor] || 0);
            });
            return total;
        }
        
        function guardarCambioDirecto(valorDenominacion) {
            const inputId = `current-qty-${valorDenominacion}`;
            const input = document.getElementById(inputId);
            const nuevaCantidad = parseInt(input.value) || 0;
            const cantidadAnterior = conteoActual[valorDenominacion] || 0;

            if (nuevaCantidad < 0) {
                 alert("La cantidad no puede ser negativa.");
                 input.value = cantidadAnterior;
                 return;
            }

            if (nuevaCantidad === cantidadAnterior) {
                return; 
            }
            
            // üö® ADVERTENCIA PARA AJUSTE MANUAL üö®
            if (!confirm(`‚ö†Ô∏è ¬°ADVERTENCIA! Est√°s ajustando la cantidad TOTAL de ${formatoMoneda(valorDenominacion)} de ${cantidadAnterior} a ${nuevaCantidad}.\n\nEste cambio sobrescribir√° el conteo actual.\n\n¬øDeseas aplicar el ajuste manual?`)) {
                input.value = cantidadAnterior;
                return;
            }
            
            let nuevoConteo = JSON.parse(JSON.stringify(conteoActual));
            let nuevoDetalle = JSON.parse(JSON.stringify(detalleMovimientos));
            let nuevoTotalRetirado = totalRetirado; 

            nuevoConteo[valorDenominacion] = nuevaCantidad;
            
            const diferencia = nuevaCantidad - cantidadAnterior;
            const signo = diferencia > 0 ? '+' : '';
            const fecha = new Date().toLocaleTimeString('es-CL');
            
            const mensaje = `[${fecha}] CORRECCI√ìN MANUAL (TOTAL): Cantidad de ${formatoMoneda(valorDenominacion)} ajustada de ${cantidadAnterior} a ${nuevaCantidad}. (Diferencia: ${signo}${diferencia})`;
            
            let nuevoMovimientoDisplay = JSON.parse(JSON.stringify(movimientoDisplay));
            nuevoMovimientoDisplay[valorDenominacion] = 'Ajuste Manual de Total'; 

            nuevoDetalle.unshift(mensaje);
            
            guardarEstado(nuevoConteo, nuevoDetalle, nuevoTotalRetirado, nuevoMovimientoDisplay); 
            aplicarEstado(historyIndex);
        }

        function actualizarCantidad(valorDenominacion, tipo) {
            const inputId = `input-qty-${valorDenominacion}`;
            const input = document.getElementById(inputId);
            const cantidad = parseInt(input.value) || 0;

            if (cantidad <= 0) {
                console.error("Por favor, ingrese una cantidad v√°lida (mayor a 0).");
                return;
            }
            
            let nuevoConteo = JSON.parse(JSON.stringify(conteoActual));
            let nuevoDetalle = JSON.parse(JSON.stringify(detalleMovimientos));
            let nuevoTotalRetirado = totalRetirado; 
            let nuevoMovimientoDisplay = JSON.parse(JSON.stringify(movimientoDisplay));

            let cantidadFinal = cantidad * tipo;
            
            if (tipo === -1) {
                if ((nuevoConteo[valorDenominacion] || 0) < cantidad) {
                    alert(`No se puede retirar ${cantidad} uds de ${formatoMoneda(valorDenominacion)}. Solo hay ${nuevoConteo[valorDenominacion] || 0} en caja.`);
                    return;
                }
                
                // üö® ADVERTENCIA PARA RETIROS/RESTAR üö®
                const montoRetiro = formatoMoneda(valorDenominacion * cantidad);
                if (!confirm(`‚ö†Ô∏è ¬°ADVERTENCIA! Est√°s a punto de registrar un RETIRO de ${cantidad} unidades de ${formatoMoneda(valorDenominacion)} (Total: ${montoRetiro}).\n\n¬øConfirmas este retiro/egreso de efectivo?`)) {
                    return; 
                }
                
                nuevoTotalRetirado += (valorDenominacion * cantidad); 
            }

            nuevoConteo[valorDenominacion] = (nuevoConteo[valorDenominacion] || 0) + cantidadFinal;
            
            const signo = tipo === 1 ? '+' : '';
            
            if (nuevoMovimientoDisplay[valorDenominacion] === 'Ajuste Manual de Total') {
                nuevoMovimientoDisplay[valorDenominacion] = '';
            }
            
            nuevoMovimientoDisplay[valorDenominacion] += signo + cantidad;

            const fecha = new Date().toLocaleTimeString('es-CL');
            let mensaje;
            if (tipo === 1) {
                mensaje = `[${fecha}] INGRESO: Se sumaron ${cantidad} uds. de ${formatoMoneda(valorDenominacion)}. (Detalle: +${cantidad})`;
            } else {
                mensaje = `[${fecha}] RETIRO: Se restaron ${cantidad} uds. de ${formatoMoneda(valorDenominacion)}. (Egreso: ${formatoMoneda(valorDenominacion * cantidad)} | Detalle: -${cantidad})`;
            }
            nuevoDetalle.unshift(mensaje);
            
            guardarEstado(nuevoConteo, nuevoDetalle, nuevoTotalRetirado, nuevoMovimientoDisplay); 
            aplicarEstado(historyIndex); 

            input.value = '';
        }
        
        function parsearMovimientos(cadena) {
            if (cadena === 'Ajuste Manual de Total') return [];
            
            if (!cadena || cadena.length === 0) return [];

            const matches = cadena.match(/[\+\-]\d+/g);
            return matches || [];
        }

        function abrirModalEdicion(valorDenominacion) {
            denominacionEnEdicion = valorDenominacion;
            const movimientosUl = document.getElementById('movimientos-edicion');
            movimientosUl.innerHTML = '';
            
            const nombreDenominacion = formatoMoneda(valorDenominacion);
            document.getElementById('edicion-detalle-titulo').textContent = `‚úèÔ∏è Editar Movimientos de ${nombreDenominacion}`;

            const movimientos = parsearMovimientos(movimientoDisplay[valorDenominacion] || '');
            
            if (movimientos.length === 0) {
                movimientosUl.innerHTML = '<li style="justify-content: center; color: #d9534f; font-style: italic;">No hay movimientos incrementales para editar.</li>';
            } else {
                movimientos.forEach((movimiento, index) => {
                    const signo = movimiento[0];
                    const cantidad = movimiento.substring(1);
                    
                    const li = document.createElement('li');
                    
                    const isPlus = signo === '+';
                    const signValue = isPlus ? '+' : '-';

                    li.innerHTML = `
                        <div class="sign-control" data-index="${index}" data-sign="${signValue}">
                            <button class="sign-btn ${isPlus ? 'active-sign' : ''}" data-value="+" onclick="toggleSign(${index}, '+')">+</button>
                            <button class="sign-btn ${!isPlus ? 'active-sign' : ''}" data-value="-" onclick="toggleSign(${index}, '-')">-</button>
                        </div>
                        <input type="number" id="qty-${index}" value="${cantidad}" min="1" required>
                    `;
                    movimientosUl.appendChild(li);
                });
            }
            
            modalEdicionDetalle.style.display = 'block';
        }
        
        function toggleSign(index, newSign) {
            const signControlDiv = document.querySelector(`.sign-control[data-index="${index}"]`);
            if (!signControlDiv) return;
            
            signControlDiv.setAttribute('data-sign', newSign);
            
            signControlDiv.querySelectorAll('.sign-btn').forEach(button => {
                if (button.getAttribute('data-value') === newSign) {
                    button.classList.add('active-sign');
                } else {
                    button.classList.remove('active-sign');
                }
            });
        }

        function guardarEdicionDetalle() {
            if (denominacionEnEdicion === null) return;

            const movimientosUl = document.getElementById('movimientos-edicion');
            let nuevaCadenaMovimientos = '';
            let nuevoTotalDenominacion = 0;
            const valorDenominacion = denominacionEnEdicion;
            
            const nombreDenominacion = formatoMoneda(valorDenominacion); 
            const listItems = movimientosUl.querySelectorAll('li');

            if (listItems.length > 0 && listItems[0].querySelector('.sign-control')) {
                listItems.forEach((li, index) => {
                    
                    const signControlDiv = li.querySelector(`.sign-control[data-index="${index}"]`);
                    if (!signControlDiv) return;
                    
                    const signo = signControlDiv.getAttribute('data-sign');
                    const cantidad = parseInt(document.getElementById(`qty-${index}`).value) || 0;
                    
                    if (cantidad > 0) {
                        nuevaCadenaMovimientos += signo + cantidad;
                        nuevoTotalDenominacion += (signo === '+') ? cantidad : -cantidad;
                    }
                });
            } else {
                nuevaCadenaMovimientos = '';
            }
            
            // üö® ADVERTENCIA PARA CORRECCI√ìN DETALLADA üö®
            if (!confirm(`‚ö†Ô∏è ¬°ADVERTENCIA! La edici√≥n de movimientos detallados de ${nombreDenominacion} est√° a punto de sobrescribir el historial de esta denominaci√≥n.\n\nNuevo Total de Unidades: ${nuevoTotalDenominacion}.\n\n¬øDeseas guardar estas correcciones?`)) {
                return;
            }

            let nuevoConteo = JSON.parse(JSON.stringify(conteoActual));
            let nuevoDetalle = JSON.parse(JSON.stringify(detalleMovimientos));
            let nuevoMovimientoDisplay = JSON.parse(JSON.stringify(movimientoDisplay));

            const totalRetiradoAnterior = totalRetirado; 

            nuevoConteo[valorDenominacion] = nuevoTotalDenominacion; 
            
            const fecha = new Date().toLocaleTimeString('es-CL');

            const mensaje = `[${fecha}] CORRECCI√ìN DETALLADA: Movimientos de ${formatoMoneda(valorDenominacion)} ajustados. Nuevo detalle: (${nuevaCadenaMovimientos || 'N/A'}). Nuevo total de unidades: ${nuevoTotalDenominacion}`;

            nuevoDetalle.unshift(mensaje);
            nuevoMovimientoDisplay[valorDenominacion] = nuevaCadenaMovimientos;
            
            guardarEstado(nuevoConteo, nuevoDetalle, totalRetiradoAnterior, nuevoMovimientoDisplay); 
            aplicarEstado(historyIndex);

            cerrarModalEdicionDetalle();
        }

        function cerrarModalEdicionDetalle() {
            modalEdicionDetalle.style.display = 'none';
            denominacionEnEdicion = null;
        }

        function actualizarListaMovimientos() {
            listaMovimientosUl.innerHTML = '';
            detalleMovimientos.forEach(movimiento => {
                const li = document.createElement('li');
                li.textContent = movimiento;
                if (movimiento.includes("RETIRO")) {
                    li.style.color = '#d9534f'; 
                    li.style.fontWeight = 'bold';
                } else if (movimiento.includes("INGRESO")) {
                    li.style.color = '#28a745';
                } else if (movimiento.includes("CORRECCI√ìN")) {
                    li.style.color = '#007bff'; 
                    li.style.fontStyle = 'italic';
                }
                listaMovimientosUl.appendChild(li);
            });
        }

        function realizarArqueo() {
            const totalContado = calcularTotalGeneral();
            
            const esperadoDisplayText = esperadoDisplay.textContent;
            
            // 1. C√°lculo de Diferencia (Contado - Esperado)
            if (mensajeArqueoP.classList.contains('error-fetch')) {
                 diferenciaSpan.textContent = formatoMoneda(0);
                 diferenciaSpan.style.color = '#333';
            } else {
                 const efectivoEsperadoRaw = esperadoDisplayText.replace(/[^0-9-]/g, ''); 
                 const efectivoEsperado = parseInt(efectivoEsperadoRaw) || 0; 
                 const diferencia = totalContado - efectivoEsperado;
                 
                 diferenciaSpan.textContent = formatoMoneda(diferencia);
                 diferenciaSpan.className = '';
                 mensajeArqueoP.className = 'mensaje';

                 if (Math.round(diferencia) === 0) { 
                     mensajeArqueoP.textContent = "¬°ARQUEO CUADRADO! üéâ";
                     mensajeArqueoP.classList.add('cuadrado');
                     diferenciaSpan.style.color = '#28a745';
                 } else if (diferencia > 0) {
                     mensajeArqueoP.textContent = `SOBRANTE: ${formatoMoneda(diferencia)} de m√°s. ‚ö†Ô∏è`;
                     mensajeArqueoP.classList.add('sobrante');
                     diferenciaSpan.style.color = '#ffc107';
                 } else {
                     mensajeArqueoP.textContent = `FALTANTE: Faltan ${formatoMoneda(Math.abs(diferencia))}. üö®`;
                     mensajeArqueoP.classList.add('faltante');
                     diferenciaSpan.style.color = '#d9534f';
                 }
            }
            
            // 2. MOSTRAR LA SUMA TOTAL DE PUNTOS
            divisionResultSpan.textContent = formatoMoneda(sumaTotalPuntos);
            divisionResultSpan.style.color = '#28a745'; 
            

            desgloseContadoDiv.innerHTML = generarDesgloseFinal();
        }

        function generarDesgloseFinal() {
            let html = '<table><tr><th>Denominaci√≥n</th><th>Cant. Total</th><th>Subtotal</th></tr>';
            
            DENOMINACIONES.forEach(valor => {
                const cantidad = conteoActual[valor] || 0;
                const subtotal = valor * cantidad;
                
                if (cantidad > 0) {
                    const esBillete = valor >= 1000;
                    const nombreTipo = esBillete ? "Billetes" : "Monedas";
                    const valorFormateado = formatoMoneda(valor);
                    
                    html += `
                        <tr>
                            <td>${nombreTipo} de ${valorFormateado}</td>
                            <td>${cantidad}</td>
                            <td>${formatoMoneda(subtotal)}</td>
                        </tr>
                    `;
                }
            });
            html += '</table>';
            return html;
        }

        function limpiarRegistros() {
            // üö® ADVERTENCIA CR√çTICA: DOBLE CONFIRMACI√ìN üö®
            if (!confirm("‚ö†Ô∏è ¬°ADVERTENCIA CR√çTICA! ‚ö†Ô∏è\n\n¬øEst√°s seguro de que quieres ELIMINAR y REINICIAR TODO el CONTEO, DETALLE y RETIROS?\n\nPRESIONA ACEPTAR SOLO SI DESEAS BORRAR COMPLETAMENTE LOS DATOS LOCALES.")) {
                return;
            }
            if (!confirm("üö® CONFIRMACI√ìN FINAL: ¬øREALMENTE deseas borrar el historial y conteo completo?")) {
                return;
            }
            
            localStorage.removeItem(STORAGE_KEY_CONTEO);
            localStorage.removeItem(STORAGE_KEY_DETALLE);
            localStorage.removeItem(STORAGE_KEY_RETIROS);
            localStorage.removeItem(STORAGE_KEY_HISTORY);
            localStorage.removeItem(STORAGE_KEY_PUNTO_DIA_VALOR);
            localStorage.removeItem(STORAGE_KEY_DIVISOR_VALOR);
            localStorage.removeItem(STORAGE_KEY_SUMA_PUNTOS); 
            localStorage.removeItem(STORAGE_KEY_DIVISOR_PLANTA);
            localStorage.removeItem(STORAGE_KEY_DIVISOR_PARTTIME);

            
            conteoActual = {};
            detalleMovimientos = [];
            totalRetirado = 0; 
            movimientoDisplay = {}; 
            history = [];
            historyIndex = -1;
            puntoDelDiaValor = 0;
            ultimoDivisor = 1.0;
            sumaTotalPuntos = 0;
            
            guardarEstado(conteoActual, detalleMovimientos, totalRetirado, movimientoDisplay);
            
            divisorPlantaInput.value = '1.0';
            divisorPartTimeInput.value = '1.0';

            generarCampos(); 
            fetchEsperadoData(); 
            fetchHistorialDetallado(false); 
            
            totalContadoFinalSpan.textContent = formatoMoneda(0);
            totalRetirosFinalSpan.textContent = formatoMoneda(0);
            diferenciaSpan.textContent = formatoMoneda(0);
            mensajeArqueoP.textContent = "";
            desgloseContadoDiv.innerHTML = "";
            puntoDelDiaSpan.textContent = formatoMoneda(0);
            divisorValueSpan.textContent = '1';
            divisionResultSpan.textContent = formatoMoneda(0);
            sumaTotalPuntosHistorialSpan.textContent = formatoMoneda(0);
            
            cerrarModalConteo();
            cerrarModalDetalle();
            cerrarModalEdicionDetalle();
        }
        
        function exportarDataToJson() {
            const dataToExport = {
                conteoActual: conteoActual,
                detalleMovimientos: detalleMovimientos,
                totalRetirado: totalRetirado,
                history: history,
                historyIndex: historyIndex,
                puntoDelDiaValor: puntoDelDiaValor,
                ultimoDivisor: ultimoDivisor,
                sumaTotalPuntos: sumaTotalPuntos,
                divisorPlanta: localStorage.getItem(STORAGE_KEY_DIVISOR_PLANTA) || '1.0', 
                divisorPartTime: localStorage.getItem(STORAGE_KEY_DIVISOR_PARTTIME) || '1.0'
            };

            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            const a = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            a.download = `respaldo_arqueo_${date}.json`;
            a.href = URL.createObjectURL(blob);
            a.click();
            
            URL.revokeObjectURL(a.href);
            alert('‚úÖ Datos exportados con √©xito como "respaldo_arqueo_YYYY-MM-DD.json"');
        }

        function importarDataFromJson(event) {
            // üö® ADVERTENCIA PARA IMPORTAR üö®
            if (!confirm("‚ö†Ô∏è ¬°ADVERTENCIA! Importar Datos JSON sobreescribir√° ABSOLUTAMENTE todo el estado actual del arqueo (conteo, retiros, historial). \n\n¬øDesea continuar con la importaci√≥n y reemplazar los datos?")) {
                event.target.value = ''; 
                return;
            }

            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.conteoActual || !importedData.history) {
                        throw new Error("Estructura de archivo JSON no v√°lida. Faltan claves principales.");
                    }

                    conteoActual = importedData.conteoActual || {};
                    detalleMovimientos = importedData.detalleMovimientos || [];
                    totalRetirado = importedData.totalRetirado || 0;
                    history = importedData.history || [];
                    historyIndex = importedData.historyIndex !== undefined ? importedData.historyIndex : -1;
                    
                    // Importar punto, divisor y suma total, asegurando el tipo de dato
                    puntoDelDiaValor = importedData.puntoDelDiaValor !== undefined ? parseInt(importedData.puntoDelDiaValor) : 0;
                    ultimoDivisor = importedData.ultimoDivisor !== undefined ? parseFloat(importedData.ultimoDivisor) : 1.0;
                    sumaTotalPuntos = importedData.sumaTotalPuntos !== undefined ? parseInt(importedData.sumaTotalPuntos) : 0;
                    
                    // Importar divisores espec√≠ficos
                    const importedDivisorPlanta = importedData.divisorPlanta || '1.0';
                    const importedDivisorPartTime = importedData.divisorPartTime || '1.0';

                    if (history.length > 0 && historyIndex >= 0) {
                        const currentState = history[historyIndex];
                        conteoActual = currentState.conteo;
                        detalleMovimientos = currentState.detalle;
                        totalRetirado = currentState.retiros;
                        movimientoDisplay = currentState.movimientoDisplay || {};
                    } else {
                        guardarEstado(conteoActual, detalleMovimientos, totalRetirado, importedData.conteoActual || {});
                    }
                    
                    guardarConteo();
                    guardarDetalle();
                    guardarRetiros();
                    guardarEstadoLocal();
                    localStorage.setItem(STORAGE_KEY_PUNTO_DIA_VALOR, puntoDelDiaValor.toString());
                    localStorage.setItem(STORAGE_KEY_DIVISOR_VALOR, ultimoDivisor.toString());
                    localStorage.setItem(STORAGE_KEY_SUMA_PUNTOS, sumaTotalPuntos.toString());
                    localStorage.setItem(STORAGE_KEY_DIVISOR_PLANTA, importedDivisorPlanta);
                    localStorage.setItem(STORAGE_KEY_DIVISOR_PARTTIME, importedDivisorPartTime);


                    generarCampos();
                    realizarArqueo();
                    
                    // Actualizar inputs de divisores y spans de resumen
                    divisorPlantaInput.value = importedDivisorPlanta;
                    divisorPartTimeInput.value = importedDivisorPartTime;
                    puntoDelDiaSpan.textContent = formatoPunto(puntoDelDiaValor);
                    divisorValueSpan.textContent = formatoFactor(ultimoDivisor);
                    sumaTotalPuntosHistorialSpan.textContent = formatoMoneda(sumaTotalPuntos);
                    divisionResultSpan.textContent = formatoMoneda(sumaTotalPuntos);
                    
                    alert('üéâ Datos importados con √©xito.');
                } catch (error) {
                    alert('‚ùå Error al importar o leer el archivo JSON: ' + error.message);
                    console.error('Error de Importaci√≥n:', error);
                } finally {
                    event.target.value = ''; 
                }
            };

            reader.readAsText(file);
        }
        
        function abrirModalConteo() {
            generarCampos(); 
            actualizarControlesHistoria();
            modalConteo.style.display = 'block';
        }
        function cerrarModalConteo(shouldRerender = false) {
            modalConteo.style.display = 'none';
            if (shouldRerender) {
                realizarArqueo(); 
            }
        }
        function abrirModalDetalle() {
            actualizarListaMovimientos();
            modalDetalle.style.display = 'block';
        }
        function cerrarModalDetalle() {
            modalDetalle.style.display = 'none';
        }
        
        window.onclick = function(event) {
            if (event.target == modalConteo) {
                cerrarModalConteo(true); 
            }
            if (event.target == modalDetalle) {
                cerrarModalDetalle();
            }
            if (event.target == modalEdicionDetalle) {
                cerrarModalEdicionDetalle();
            }
            if (event.target == historyModal) { 
                closeHistoryModal();
            }
        }

        window.onload = function() {
            cargarEstado(); 
            generarCampos(); 
            actualizarControlesHistoria();
            fetchEsperadoData(); 
            // Llamada para cargar el historial (solo para el c√°lculo de la suma)
            fetchHistorialDetallado(false); 
            
            // Event listeners para guardar los divisores espec√≠ficos
            divisorPlantaInput.addEventListener('change', function() {
                localStorage.setItem(STORAGE_KEY_DIVISOR_PLANTA, this.value);
                // Si el modal est√° abierto, actualizamos la lista de filtros
                if (historyModal.style.display === 'block') {
                    populateDivisorFilter();
                }
            });
            divisorPartTimeInput.addEventListener('change', function() {
                localStorage.setItem(STORAGE_KEY_DIVISOR_PARTTIME, this.value);
                // Si el modal est√° abierto, actualizamos la lista de filtros
                 if (historyModal.style.display === 'block') {
                    populateDivisorFilter();
                }
            });
        };
    </script>
</body>
</html>